<!-- c:\Users\Glauber\OneDrive\Documentos\DevAcaiteria\public\index.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disparador Telegram + DB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log-box { background: #000; color: #0f0; height: 300px; overflow-y: scroll; font-family: monospace; padding: 10px; border-radius: 5px; }
        .step-section { display: none; }
        .step-section.active { display: block; }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <h2 class="text-center mb-4">üöÄ Disparador A√ßa√≠teria</h2>

    <!-- Navega√ß√£o -->
    <ul class="nav nav-tabs mb-4" id="myTab">
        <li class="nav-item"><a class="nav-link" href="#" onclick="showTab('send')">Enviar</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="showTab('templates')">Templates</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="showTab('filters')">Filtros Inteligentes</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="showTab('login')">Conex√£o</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="showTab('contacts')">Contatos</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="showTab('logs_tab')">Hist√≥rico</a></li>
        <li class="nav-item"><a class="nav-link active" href="#" onclick="showTab('config')">Configura√ß√£o</a></li>
    </ul>

    <!-- 1. Configura√ß√£o -->
    <div id="config" class="step-section active card p-4">
        <h4>Configura√ß√µes da API</h4>
        <div class="mb-3">
            <label>API ID</label>
            <input type="text" id="apiId" class="form-control">
        </div>
        <div class="mb-3">
            <label>API Hash</label>
            <input type="text" id="apiHash" class="form-control">
        </div>
        <div class="mb-3">
            <label>Sess√£o (Salva no Banco)</label>
            <input type="text" id="session" class="form-control" disabled placeholder="Gerado automaticamente">
        </div>
        <button class="btn btn-primary" onclick="saveConfig()">Salvar Configura√ß√£o</button>
    </div>

    <!-- 2. Login -->
    <div id="login" class="step-section card p-4">
        <h4>Conectar ao Telegram</h4>
        <button class="btn btn-success mb-3" onclick="startLogin()">Iniciar Conex√£o</button>
        <div id="loginInputs" style="display:none;">
            <div id="inputPhone" class="mb-2">
                <label>Telefone (+55...)</label>
                <div class="input-group">
                    <input type="text" id="phoneVal" class="form-control">
                    <button class="btn btn-outline-secondary" onclick="sendInput('phone')">Enviar</button>
                </div>
            </div>
            <div id="inputCode" class="mb-2" style="display:none;">
                <label>C√≥digo do Telegram</label>
                <div class="input-group">
                    <input type="text" id="codeVal" class="form-control">
                    <button class="btn btn-outline-secondary" onclick="sendInput('code')">Enviar</button>
                </div>
            </div>
            <div id="inputPassword" class="mb-2" style="display:none;">
                <label>Senha 2FA</label>
                <div class="input-group">
                    <input type="password" id="passVal" class="form-control">
                    <button class="btn btn-outline-secondary" onclick="sendInput('password')">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Contatos (DB) -->
    <div id="contacts" class="step-section card p-4">
        <h4>Cadastro de Contatos</h4>
        <div class="input-group mb-3">
            <input type="text" id="newContactName" class="form-control" placeholder="Nome">
            <input type="text" id="newContactPhone" class="form-control" placeholder="Telefone (55...)">
            <button class="btn btn-success" onclick="addContact()">Adicionar</button>
            <button class="btn btn-warning ms-2" onclick="importTelegramContacts()">üì• Importar do Telegram</button>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-2">
            <select id="contactsLimit" class="form-select w-auto" onchange="loadContacts(1)">
                <option value="10">10 por p√°gina</option>
                <option value="20">20 por p√°gina</option>
                <option value="50">50 por p√°gina</option>
            </select>
            <span id="contactsTotal" class="fw-bold"></span>
        </div>

        <ul id="contactsList" class="list-group mb-3"></ul>
        
        <nav>
            <ul class="pagination justify-content-center" id="contactsPagination"></ul>
        </nav>
    </div>

    <!-- 4. Templates -->
    <div id="templates" class="step-section card p-4">
        <h4>Templates de Mensagem</h4>
        <div class="mb-3">
            <input type="text" id="tplName" class="form-control mb-2" placeholder="Nome do Template (ex: Promo√ß√£o Natal)">
            <textarea id="tplMsg" class="form-control mb-2" placeholder="Mensagem..."></textarea>
            <button class="btn btn-success" onclick="addTemplate()">Salvar Template</button>
        </div>
        <ul id="templatesList" class="list-group"></ul>
    </div>

    <!-- Filtros Inteligentes -->
    <div id="filters" class="step-section card p-4">
        <h4>Filtros de Envio</h4>
        <p class="text-muted">Encontre contatos que n√£o recebem mensagens h√° algum tempo.</p>
        <div class="row mb-3">
            <div class="col">
                <label>Dias sem envio (m√≠nimo)</label>
                <input type="number" id="filterDays" class="form-control" value="10">
            </div>
            <div class="col">
                <label>Limite de contatos</label>
                <input type="number" id="filterLimit" class="form-control" value="10">
            </div>
            <div class="col d-flex align-items-end">
                <button id="btnFilterSearch" class="btn btn-info w-100" onclick="previewFilter()">üîç Buscar</button>
            </div>
        </div>
        
        <div id="filterResults" class="mb-3"></div>
        
        <button id="btnSendFilter" class="btn btn-success w-100" style="display:none;" onclick="prepareFilterSend()">
            ‚úÖ Enviar Campanha para estes contatos
        </button>
    </div>

    <!-- 5. Enviar -->
    <div id="send" class="step-section card p-4">
        <h4>Criar Campanha</h4>
        <form id="sendForm">
            <div class="mb-3">
                <label>Fonte dos Contatos</label>
                <select id="sourceSelect" class="form-select" onchange="toggleSource()">
                    <option value="csv">Upload de Arquivo CSV</option>
                    <option value="db_all">Todos os Contatos do Banco</option>
                    <option value="db_filter">Filtro Personalizado (Configurado na aba Filtros)</option>
                </select>
            </div>

            <!-- Inputs ocultos para o filtro -->
            <div id="filterInputs" style="display:none;" class="alert alert-info">
                <input type="hidden" name="filterDays" id="hiddenFilterDays">
                <input type="hidden" name="filterLimit" id="hiddenFilterLimit">
                <strong>Modo Filtro Ativo:</strong> Enviando para contatos sem mensagens h√° <span id="lblDays"></span> dias (Limite: <span id="lblLimit"></span>).
            </div>

            <div class="mb-3">
                <label>Mensagem</label>
                <textarea name="message" id="sendMsg" class="form-control" rows="3"></textarea>
                <small class="text-muted"><a href="#" onclick="showTab('templates')">Copiar de um template</a></small>
            </div>

            <div class="mb-3" id="csvInputDiv">
                <label>Lista de Contatos (CSV)</label>
                <input type="file" name="csv" class="form-control" accept=".csv">
            </div>

            <div class="mb-3">
                <label>Imagem (Opcional)</label>
                <div class="input-group">
                    <input type="file" name="image" id="fileInput" class="form-control" accept="image/*" onchange="clearGallerySelection()">
                    <button type="button" class="btn btn-outline-secondary" onclick="openGallery()">üñºÔ∏è Galeria</button>
                </div>
                <input type="hidden" name="galleryId" id="galleryId">
                <div id="selectedGalleryImage" class="mt-2" style="display:none;">
                    <span class="badge bg-primary">Imagem da Galeria Selecionada</span>
                    <img id="previewGallery" src="" style="height: 50px; border: 1px solid #ccc; margin-left: 10px;">
                    <button type="button" class="btn btn-sm btn-danger ms-2" onclick="clearGallerySelection()">X</button>
                </div>
            </div>
            <div class="mb-3">
                <label>Delay (ms)</label>
                <input type="number" name="delay" class="form-control" value="3000">
            </div>
            <button type="submit" class="btn btn-danger w-100">INICIAR DISPAROS</button>
            <button type="button" class="btn btn-warning w-100 mt-2" onclick="stopSending()">PARAR ENVIO</button>
        </form>
        
        <div class="mt-4">
            <h5>Logs de Execu√ß√£o:</h5>
            <div id="logs" class="log-box"></div>
        </div>
    </div>

    <!-- 6. Hist√≥rico -->
    <div id="logs_tab" class="step-section card p-4">
        <h4>Hist√≥rico de Envios (Banco de Dados)</h4>
        <button class="btn btn-sm btn-secondary mb-2" onclick="loadDbLogs()">Atualizar</button>
        <table class="table table-striped">
            <thead><tr><th>Data</th><th>Telefone</th><th>Status</th><th>Erro</th></tr></thead>
            <tbody id="dbLogsTable"></tbody>
        </table>
    </div>
</div>

<!-- Toast Container (Notifica√ß√µes) -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100"></div>

<!-- Modal de Alerta (Estilo Moderno) -->
<div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center pb-4">
                <div class="mb-3 text-warning">
                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="currentColor" class="bi bi-exclamation-circle" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
                    </svg>
                </div>
                <h4 id="alertModalLabel" class="mb-2">Aten√ß√£o</h4>
                <p id="alertModalBody" class="text-muted"></p>
            </div>
            <div class="modal-footer border-0 justify-content-center pt-0">
                <button type="button" class="btn btn-primary px-5" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Confirma√ß√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p id="confirmModalBody" class="mb-0"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmBtnAction">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Galeria -->
<div class="modal fade" id="galleryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Galeria de Imagens</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="closeGallery()"></button>
            </div>
            <div class="modal-body">
                <div id="galleryGrid" class="row g-3"></div>
            </div>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const socket = io();
    const logBox = document.getElementById('logs');

    function showTab(id) {
        document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        // Carregar dados ao abrir aba
        if(id === 'contacts') loadContacts();
        if(id === 'templates') loadTemplates();
        if(id === 'logs_tab') loadDbLogs();
    }

    function toggleSource() {
        const val = document.getElementById('sourceSelect').value;
        document.getElementById('csvInputDiv').style.display = val === 'csv' ? 'block' : 'none';
        document.getElementById('filterInputs').style.display = val === 'db_filter' ? 'block' : 'none';
    }

    function log(msg) {
        const div = document.createElement('div');
        div.textContent = `> ${msg}`;
        logBox.appendChild(div);
        logBox.scrollTop = logBox.scrollHeight;
    }

    // --- Notifica√ß√µes (Toasts) e Alertas (Modal) ---
    function showToast(message, type = 'success') {
        const container = document.querySelector('.toast-container');
        let bgClass = 'bg-primary text-white';
        let closeBtnClass = 'btn-close-white';
        
        // Cores solicitadas: Green (Success), Yellow (Caution), Red (Error)
        if (type === 'success') bgClass = 'bg-success text-white';
        else if (type === 'warning') { bgClass = 'bg-warning text-dark'; closeBtnClass = ''; }
        else if (type === 'error') bgClass = 'bg-danger text-white';

        const toastHtml = `
            <div class="toast align-items-center ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close ${closeBtnClass} me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>`;
        
        const div = document.createElement('div');
        div.innerHTML = toastHtml;
        const toastEl = div.firstElementChild;
        container.appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
        toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    }

    const alertModalObj = new bootstrap.Modal(document.getElementById('alertModal'));
    function showAlert(message, title = 'Aten√ß√£o') {
        document.getElementById('alertModalLabel').innerText = title;
        document.getElementById('alertModalBody').innerText = message;
        alertModalObj.show();
    }

    // --- L√≥gica do Modal de Confirma√ß√£o ---
    const confirmModalObj = new bootstrap.Modal(document.getElementById('confirmModal'));
    let confirmResolver = null;

    document.getElementById('confirmBtnAction').onclick = () => {
        if(confirmResolver) confirmResolver(true);
        confirmResolver = null; // Evita dupla resolu√ß√£o
        confirmModalObj.hide();
    };
    document.getElementById('confirmModal').addEventListener('hidden.bs.modal', () => {
        if(confirmResolver) {
            confirmResolver(false);
            confirmResolver = null;
        }
    });

    function showConfirm(message, title = 'Confirma√ß√£o', btnText = 'Confirmar', btnClass = 'btn-primary') {
        document.getElementById('confirmModalLabel').innerText = title;
        document.getElementById('confirmModalBody').innerText = message;
        const btn = document.getElementById('confirmBtnAction');
        btn.innerText = btnText;
        btn.className = `btn ${btnClass}`;
        
        confirmModalObj.show();
        return new Promise(resolve => { confirmResolver = resolve; });
    }

    // --- API Calls ---
    
    // Config
    fetch('/api/config').then(r => r.json()).then(data => {
        document.getElementById('apiId').value = data.apiId;
        document.getElementById('apiHash').value = data.apiHash;
        document.getElementById('session').value = data.session;
    });

    function saveConfig() {
        fetch('/api/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                apiId: document.getElementById('apiId').value,
                apiHash: document.getElementById('apiHash').value,
                session: document.getElementById('session').value
            })
        }).then(() => showToast('Configura√ß√£o Salva!', 'success'));
    }

    // Login
    function startLogin() {
        document.getElementById('loginInputs').style.display = 'block';
        fetch('/api/login/start', { method: 'POST' });
    }
    function sendInput(type) {
        const idMap = { 'phone': 'phoneVal', 'code': 'codeVal', 'password': 'passVal' };
        const val = document.getElementById(idMap[type]).value;
        fetch('/api/login/input', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ type, value: val })
        });
    }

    // Contatos DB
    function loadContacts(page = 1) {
        const limit = document.getElementById('contactsLimit') ? document.getElementById('contactsLimit').value : 10;
        
        fetch(`/api/db/contacts?page=${page}&limit=${limit}`).then(r => r.json()).then(data => {
            const list = document.getElementById('contactsList');
            list.innerHTML = '';
            
            // Suporte para o novo formato paginado
            const contacts = data.contacts || [];
            const total = data.total || 0;

            contacts.forEach(c => {
                list.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>${c.name || 'Sem Nome'} - ${c.phone}</span>
                    <span class="badge bg-secondary rounded-pill">${c.message_count} envios</span>
                </li>`;
            });

            // Atualizar Pagina√ß√£o
            if(document.getElementById('contactsTotal')) {
                document.getElementById('contactsTotal').innerText = `Total: ${total}`;
                renderPagination(total, page, limit);
            }
        });
    }

    function renderPagination(total, page, limit) {
        const totalPages = Math.ceil(total / limit);
        const pagination = document.getElementById('contactsPagination');
        pagination.innerHTML = '';
        
        if(totalPages <= 1) return;

        // Anterior
        pagination.innerHTML += `<li class="page-item ${page === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadContacts(${page - 1})">Anterior</a>
        </li>`;

        // P√°ginas (Simplificado: mostra atual e vizinhos)
        for(let i = 1; i <= totalPages; i++) {
             if (i === 1 || i === totalPages || (i >= page - 2 && i <= page + 2)) {
                pagination.innerHTML += `<li class="page-item ${i === page ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadContacts(${i})">${i}</a>
                </li>`;
             } else if (pagination.lastChild.innerText !== '...') {
                 if ((i === page - 3 && i > 1) || (i === page + 3 && i < totalPages)) {
                    pagination.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                 }
             }
        }

        // Pr√≥ximo
        pagination.innerHTML += `<li class="page-item ${page === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadContacts(${page + 1})">Pr√≥ximo</a>
        </li>`;
    }

    function addContact() {
        const name = document.getElementById('newContactName').value;
        const phone = document.getElementById('newContactPhone').value;
        fetch('/api/db/contacts', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, phone })
        }).then(() => {
            document.getElementById('newContactName').value = '';
            document.getElementById('newContactPhone').value = '';
            loadContacts();
        });
    }
    async function importTelegramContacts() {
        if(!await showConfirm("Isso ir√° importar todos os contatos da sua conta do Telegram para o banco de dados. Deseja continuar?", "Importar Contatos", "Importar", "btn-warning")) return;
        
        // Feedback visual
        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = "Importando...";
        btn.disabled = true;

        fetch('/api/telegram/import-contacts', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                } else {
                    showAlert(data.error, 'Erro na Importa√ß√£o');
                }
                loadContacts(); // Recarrega a lista na tela
            })
            .finally(() => {
                btn.innerText = originalText;
                btn.disabled = false;
            });
    }

    // Templates DB
    function loadTemplates() {
        fetch('/api/db/templates').then(r => r.json()).then(data => {
            const list = document.getElementById('templatesList');
            list.innerHTML = '';
            data.forEach(t => {
                list.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    <div><strong>${t.name}</strong>: ${t.message.substring(0,30)}...</div>
                    <button class="btn btn-sm btn-info" onclick="useTemplate('${encodeURIComponent(t.message)}')">Usar</button>
                </li>`;
            });
        });
    }
    function addTemplate() {
        const name = document.getElementById('tplName').value;
        const message = document.getElementById('tplMsg').value;
        fetch('/api/db/templates', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, message })
        }).then(() => {
            document.getElementById('tplName').value = '';
            document.getElementById('tplMsg').value = '';
            loadTemplates();
        });
    }
    function useTemplate(msg) {
        document.getElementById('sendMsg').value = decodeURIComponent(msg);
        showTab('send');
    }

    // Logs DB
    function loadDbLogs() {
        fetch('/api/db/logs').then(r => r.json()).then(data => {
            const tbody = document.getElementById('dbLogsTable');
            tbody.innerHTML = '';
            data.forEach(l => {
                tbody.innerHTML += `<tr>
                    <td>${new Date(l.sent_at).toLocaleString()}</td>
                    <td>${l.phone}</td>
                    <td>${l.status}</td>
                    <td>${l.error_details || ''}</td>
                </tr>`;
            });
        });
    }

    // Filtros
    function previewFilter() {
        const days = document.getElementById('filterDays').value;
        const limit = document.getElementById('filterLimit').value;
        const btn = document.getElementById('btnFilterSearch');
        const originalText = btn.innerText;
        
        btn.innerText = "Buscando...";
        btn.disabled = true;
        const resultsDiv = document.getElementById('filterResults');
        resultsDiv.innerHTML = '';
        
        fetch('/api/db/filter-preview', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ days, limit })
        }).then(r => r.json()).then(data => {
            if (data.error) throw new Error(data.error);

            if(!Array.isArray(data) || data.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-warning">Nenhum contato encontrado com estes crit√©rios.</div>';
                document.getElementById('btnSendFilter').style.display = 'none';
                return;
            }
            
            let html = `<table class="table table-sm"><thead><tr><th>Nome</th><th>Telefone</th><th>√öltimo Envio</th><th>Total</th></tr></thead><tbody>`;
            data.forEach(c => {
                const last = c.last_sent_at ? new Date(c.last_sent_at).toLocaleDateString() : 'Nunca';
                html += `<tr><td>${c.name || 'Sem Nome'}</td><td>${c.phone}</td><td>${last}</td><td>${c.message_count}</td></tr>`;
            });
            html += `</tbody></table>`;
            resultsDiv.innerHTML = html;
            document.getElementById('btnSendFilter').style.display = 'block';
        }).catch(err => {
            console.error(err);
            showToast(`Erro: ${err.message}`, 'error');
        }).finally(() => {
            btn.innerText = originalText;
            btn.disabled = false;
        });
    }

    function prepareFilterSend() {
        const days = document.getElementById('filterDays').value;
        const limit = document.getElementById('filterLimit').value;
        document.getElementById('hiddenFilterDays').value = days;
        document.getElementById('hiddenFilterLimit').value = limit;
        document.getElementById('lblDays').innerText = days;
        document.getElementById('lblLimit').innerText = limit;
        
        showTab('send');
        const select = document.getElementById('sourceSelect');
        select.value = 'db_filter';
        toggleSource();
    }

    // --- Galeria ---
    const galleryModal = new bootstrap.Modal(document.getElementById('galleryModal'));

    function openGallery() {
        loadGallery();
        galleryModal.show();
    }
    function closeGallery() {
        galleryModal.hide();
    }

    function loadGallery() {
        fetch('/api/db/gallery').then(r => r.json()).then(data => {
            const grid = document.getElementById('galleryGrid');
            grid.innerHTML = '';
            if(data.length === 0) {
                grid.innerHTML = '<p class="text-center text-muted">Nenhuma imagem salva. Envie uma campanha com imagem para salvar aqui.</p>';
                return;
            }
            data.forEach(img => {
                // Corrige barras invertidas do Windows para exibir no navegador
                const webPath = img.path.replace(/\\/g, '/');
                grid.innerHTML += `
                <div class="col-md-3 col-6 text-center">
                    <div class="card h-100">
                        <img src="/${webPath}" class="card-img-top" style="height: 100px; object-fit: cover; cursor: pointer;" onclick="selectGalleryImage(${img.id}, '/${webPath}')">
                        <div class="card-body p-2">
                            <small class="d-block text-truncate" title="${img.original_name}">${img.original_name}</small>
                            <button class="btn btn-sm btn-danger mt-1" onclick="deleteGalleryImage(${img.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>`;
            });
        });
    }

    function selectGalleryImage(id, path) {
        document.getElementById('galleryId').value = id;
        document.getElementById('fileInput').value = ''; // Limpa upload manual
        document.getElementById('selectedGalleryImage').style.display = 'block';
        document.getElementById('previewGallery').src = path;
        closeGallery();
    }

    function clearGallerySelection() {
        document.getElementById('galleryId').value = '';
        document.getElementById('selectedGalleryImage').style.display = 'none';
    }

    async function deleteGalleryImage(id) {
        if(!await showConfirm("Excluir imagem permanentemente?", "Excluir Imagem", "Excluir", "btn-danger")) return;
        fetch(`/api/db/gallery/${id}`, { method: 'DELETE' }).then(() => loadGallery());
    }

    // Envio
    document.getElementById('sendForm').onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        // Adicionar tipo de fonte
        const sourceType = document.getElementById('sourceSelect').value;
        formData.append('sourceType', sourceType);

        if(!await showConfirm("Tem certeza que deseja iniciar os disparos?", "Iniciar Campanha", "Iniciar", "btn-success")) return;
        
        const res = await fetch('/api/send', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
            showToast(data.message, 'success');
        } else {
            showAlert(data.error || data.message, 'Erro no Envio');
        }
    };

    // Parar Envio
    async function stopSending() {
        if(!await showConfirm("Deseja realmente parar o envio em massa?", "Parar Envio", "Parar", "btn-danger")) return;
        fetch('/api/stop', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                log("üõë " + data.message);
                showToast(data.message, 'warning');
            });
    }

    // Socket Events
    socket.on('log', msg => log(msg));
    socket.on('status', status => {
        if(status === 'waiting_phone') document.getElementById('inputPhone').style.display = 'block';
        if(status === 'waiting_code') {
            document.getElementById('inputPhone').style.display = 'none';
            document.getElementById('inputCode').style.display = 'block';
        }
        if(status === 'waiting_password') {
            document.getElementById('inputCode').style.display = 'none';
            document.getElementById('inputPassword').style.display = 'block';
        }
        if(status === 'ready') {
            document.getElementById('loginInputs').style.display = 'none';
            showToast("Conectado com sucesso!", 'success');
            showTab('send');
        }
    });
</script>
</body>
</html>
